<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器资源协调系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.leancloud.cn/sdk/js/av-min-1.10.0.js"></script>
    <script src="https://cdn.leancloud.cn/sdk/js/leancloud-realtime-2.0.0.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-lift:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(22, 93, 255, 0.15);
            }
            .progress-shine {
                position: relative;
                overflow: hidden;
            }
            .progress-shine::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                animation: shine 2s infinite;
            }
            @keyframes shine {
                100% {
                    left: 100%;
                }
            }
            .form-error {
                border-color: #F53F3F !important;
            }
            .error-text {
                color: #F53F3F;
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-server text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">服务器资源协调系统</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <span class="text-sm text-gray-600"><i class="fa fa-clock-o mr-1"></i><span id="current-time">加载中...</span></span>
            </div>
            <button class="md:hidden text-gray-500">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态概览 -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold">资源状态概览</h2>
                <div class="flex items-center space-x-2 bg-primary/10 text-primary px-3 py-1 rounded-full text-sm">
                    <i class="fa fa-refresh"></i>
                    <span id="last-update">同步中...</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- 服务器1 -->
                <div class="server-card bg-white rounded-xl p-5 card-shadow hover-lift" data-server-id="1" data-total-cores="128">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">服务器 #1</h3>
                            <p class="text-gray-500 text-sm">总核数: 128</p>
                        </div>
                        <span class="server-status bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">同步中...</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>剩余核数</span>
                            <span class="font-medium remaining-cores">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="server-progress bg-success h-2.5 rounded-full progress-shine" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between text-sm">
                            <div class="flex items-center text-gray-500">
                                <i class="fa fa-tasks mr-1"></i>
                                <span class="active-tasks">-- 个任务</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                                查看详情 <i class="fa fa-angle-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 服务器2 -->
                <div class="server-card bg-white rounded-xl p-5 card-shadow hover-lift" data-server-id="2" data-total-cores="192">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">服务器 #2</h3>
                            <p class="text-gray-500 text-sm">总核数: 192</p>
                        </div>
                        <span class="server-status bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">同步中...</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>剩余核数</span>
                            <span class="font-medium remaining-cores">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="server-progress bg-success h-2.5 rounded-full progress-shine" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between text-sm">
                            <div class="flex items-center text-gray-500">
                                <i class="fa fa-tasks mr-1"></i>
                                <span class="active-tasks">-- 个任务</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                                查看详情 <i class="fa fa-angle-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 服务器3 -->
                <div class="server-card bg-white rounded-xl p-5 card-shadow hover-lift" data-server-id="3" data-total-cores="192">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">服务器 #3</h3>
                            <p class="text-gray-500 text-sm">总核数: 192</p>
                        </div>
                        <span class="server-status bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">同步中...</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>剩余核数</span>
                            <span class="font-medium remaining-cores">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="server-progress bg-success h-2.5 rounded-full progress-shine" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between text-sm">
                            <div class="flex items-center text-gray-500">
                                <i class="fa fa-tasks mr-1"></i>
                                <span class="active-tasks">-- 个任务</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                                查看详情 <i class="fa fa-angle-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 服务器4 -->
                <div class="server-card bg-white rounded-xl p-5 card-shadow hover-lift" data-server-id="4" data-total-cores="192">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">服务器 #4</h3>
                            <p class="text-gray-500 text-sm">总核数: 192</p>
                        </div>
                        <span class="server-status bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">同步中...</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>剩余核数</span>
                            <span class="font-medium remaining-cores">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="server-progress bg-success h-2.5 rounded-full progress-shine" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between text-sm">
                            <div class="flex items-center text-gray-500">
                                <i class="fa fa-tasks mr-1"></i>
                                <span class="active-tasks">-- 个任务</span>
                            </div>
                            <button class="text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                                查看详情 <i class="fa fa-angle-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 资源申请和使用记录 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 资源申请表单 -->
            <section class="lg:col-span-1 bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold mb-5">资源申请</h2>
                
                <form id="resource-form" class="space-y-4">
                    <div>
                        <label for="applicant" class="block text-sm font-medium text-gray-700 mb-1">申请人</label>
                        <input type="text" id="applicant" name="applicant" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
                            placeholder="请输入您的姓名">
                        <div id="applicant-error" class="error-text hidden">请输入申请人姓名</div>
                    </div>
                    
                    <div>
                        <label for="cores" class="block text-sm font-medium text-gray-700 mb-1">所需核数</label>
                        <input type="number" id="cores" name="cores" min="1" max="192" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
                            placeholder="请输入需要的核数">
                        <p class="text-xs text-gray-500 mt-1">提示：单台服务器最多可申请192核</p>
                        <div id="cores-error" class="error-text hidden">请输入有效的核数（1-192之间）</div>
                    </div>
                    
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                        <input type="datetime-local" id="start-time" name="start-time" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
                        <div id="start-time-error" class="error-text hidden">请选择开始时间</div>
                    </div>
                    
                    <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">结束时间</label>
                        <input type="datetime-local" id="end-time" name="end-time" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
                        <div id="end-time-error" class="error-text hidden">结束时间必须晚于开始时间</div>
                    </div>
                    
                    <div>
                        <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">使用用途</label>
                        <textarea id="purpose" name="purpose" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
                            placeholder="请简要描述使用用途（可选）"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fa fa-paper-plane mr-2"></i> 提交申请
                    </button>
                </form>
            </section>
            
            <!-- 使用记录 -->
            <section class="lg:col-span-2 bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-bold">使用记录</h2>
                    <div class="relative">
                        <input type="text" id="search-records" placeholder="搜索记录..."
                            class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors text-sm w-full md:w-64">
                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请人</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">服务器</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">核数</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">开始时间</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">结束时间</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            </tr>
                        </thead>
                        <tbody id="records-table" class="bg-white divide-y divide-gray-200">
                            <tr class="text-center">
                                <td colspan="6" class="px-4 py-8 text-gray-500">同步中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
    
    <!-- 通知区域 -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-50 flex flex-col space-y-3 max-w-sm"></div>
    
    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-10">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2023 服务器资源协调系统</p>
        </div>
    </footer>

    <script>
        // ==============================================
        // LeanCloud 配置 - 已填入您提供的信息
        // ==============================================
        const APP_ID = 'iYx24wgaGnaFX1X1XgcMfVi-gzGzoHsz';
        const APP_KEY = 'moFg3wrTtdhqVJroM2UHOtof';
        const SERVER_URL = 'https://iyx24wga.lc-cn-n1-shared.com';
        
        // 初始化LeanCloud
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });

        // ==============================================
        // 全局变量
        // ==============================================
        let servers = [];
        let records = [];
        let serverSubscription = null;
        let recordSubscription = null;

        // ==============================================
        // 初始化函数
        // ==============================================
        function init() {
            // 初始化时间选择器
            initDateTimePickers();

            // 绑定事件处理函数
            bindEventListeners();

            // 初始化服务器数据（首次使用）
            initServerData();
            
            // 加载并监听数据
            loadAndSubscribeData();

            // 启动时间更新
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }

        // ==============================================
        // 事件绑定
        // ==============================================
        function bindEventListeners() {
            // 表单提交
            document.getElementById('resource-form').addEventListener('submit', handleFormSubmit);

            // 搜索记录
            document.getElementById('search-records').addEventListener('input', (e) => {
                searchRecords(e.target.value);
            });
        }

        // ==============================================
        // 数据处理
        // ==============================================
        function initServerData() {
            // 检查是否已有服务器数据，没有则初始化
            const serverQuery = new AV.Query('Server');
            serverQuery.count().then(count => {
                if (count === 0) {
                    // 初始化服务器数据
                    const initialServers = [
                        { id: 1, totalCores: 128, usedCores: 0, tasks: [] },
                        { id: 2, totalCores: 192, usedCores: 0, tasks: [] },
                        { id: 3, totalCores: 192, usedCores: 0, tasks: [] },
                        { id: 4, totalCores: 192, usedCores: 0, tasks: [] }
                    ];
                    
                    // 保存到数据库
                    initialServers.forEach(server => {
                        const ServerClass = AV.Object.extend('Server');
                        const serverObject = new ServerClass();
                        serverObject.set('id', server.id);
                        serverObject.set('totalCores', server.totalCores);
                        serverObject.set('usedCores', server.usedCores);
                        serverObject.set('tasks', server.tasks);
                        serverObject.save();
                    });
                }
            });
        }

        function loadAndSubscribeData() {
            // 加载服务器数据
            const serverQuery = new AV.Query('Server');
            serverQuery.find().then(results => {
                servers = results.map(result => result.toJSON());
                updateServerDisplay();
                document.getElementById('last-update').textContent = '刚刚更新';
            }).catch(error => {
                console.error('加载服务器数据失败:', error);
                showNotification('加载服务器数据失败，请刷新页面重试', 'error');
            });

            // 订阅服务器数据更新
            serverSubscription = AV.Object.subscribe('Server');
            serverSubscription.on('update', object => {
                const updatedServer = object.toJSON();
                servers = servers.map(server => 
                    server.id === updatedServer.id ? updatedServer : server
                );
                updateServerDisplay();
                document.getElementById('last-update').textContent = '刚刚更新';
            });

            // 加载记录数据
            const recordQuery = new AV.Query('Record');
            recordQuery.find().then(results => {
                records = results.map(result => result.toJSON());
                updateRecordsTable();
            }).catch(error => {
                console.error('加载记录数据失败:', error);
                showNotification('加载记录数据失败，请刷新页面重试', 'error');
            });

            // 订阅记录数据更新
            recordSubscription = AV.Object.subscribe('Record');
            recordSubscription.on('create', object => {
                records.push(object.toJSON());
                updateRecordsTable();
                showNotification('有新的资源申请记录', 'info');
            });
        }

        // ==============================================
        // 时间处理
        // ==============================================
        function updateCurrentTime() {
            const now = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN', options);
        }

        function initDateTimePickers() {
            const now = new Date();
            const minDateTime = now.toISOString().slice(0, 16);

            document.getElementById('start-time').min = minDateTime;
            document.getElementById('start-time').value = minDateTime;

            // 结束时间默认设置为1小时后
            now.setHours(now.getHours() + 1);
            const defaultEndTime = now.toISOString().slice(0, 16);
            document.getElementById('end-time').value = defaultEndTime;
        }

        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==============================================
        // 表单验证
        // ==============================================
        function clearFormErrors() {
            const inputs = document.querySelectorAll('#resource-form input, #resource-form textarea');
            inputs.forEach(input => {
                input.classList.remove('form-error');
            });

            const errorElements = document.querySelectorAll('[id$="-error"]');
            errorElements.forEach(el => {
                el.classList.add('hidden');
            });
        }

        function showFormError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(`${fieldId}-error`);

            input.classList.add('form-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        // ==============================================
        // UI更新
        // ==============================================
        function updateServerDisplay() {
            servers.forEach(server => {
                const card = document.querySelector(`.server-card[data-server-id="${server.id}"]`);
                if (!card) return;

                const remainingCores = server.totalCores - server.usedCores;
                const usagePercentage = (server.usedCores / server.totalCores) * 100;

                // 更新剩余核数
                card.querySelector('.remaining-cores').textContent = remainingCores;

                // 更新进度条
                const progressBar = card.querySelector('.server-progress');
                progressBar.style.width = `${usagePercentage}%`;

                // 更新状态和进度条颜色
                const statusElement = card.querySelector('.server-status');
                if (usagePercentage === 0) {
                    statusElement.className = 'server-status bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium';
                    statusElement.textContent = '可用';
                    progressBar.className = 'server-progress bg-success h-2.5 rounded-full progress-shine';
                } else if (usagePercentage < 100) {
                    statusElement.className = 'server-status bg-warning/10 text-warning px-2 py-1 rounded-full text-xs font-medium';
                    statusElement.textContent = '部分占用';
                    progressBar.className = 'server-progress bg-warning h-2.5 rounded-full progress-shine';
                } else {
                    statusElement.className = 'server-status bg-danger/10 text-danger px-2 py-1 rounded-full text-xs font-medium';
                    statusElement.textContent = '满载';
                    progressBar.className = 'server-progress bg-danger h-2.5 rounded-full progress-shine';
                }

                // 更新任务数量
                card.querySelector('.active-tasks').textContent = `${server.tasks.length} 个任务`;
            });
        }

        function updateRecordsTable() {
            const tableBody = document.getElementById('records-table');
            tableBody.innerHTML = '';

            if (records.length === 0) {
                tableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="6" class="px-4 py-8 text-gray-500">暂无使用记录</td>
                    </tr>
                `;
                return;
            }

            // 按开始时间排序，最新的在前面
            const sortedRecords = [...records].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';

                const now = new Date();
                const startTime = new Date(record.startTime);
                const endTime = new Date(record.endTime);

                let statusClass = '';
                let statusText = '';

                if (now < startTime) {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = '等待中';
                } else if (now >= startTime && now <= endTime) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = '使用中';
                } else {
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusText = '已结束';
                }

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${record.applicant}</td>
                    <td class="px-4 py-4 whitespace-nowrap">服务器 #${record.serverId}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${record.cores}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${formatDateTime(startTime)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${formatDateTime(endTime)}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // ==============================================
        // 通知功能
        // ==============================================
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');

            let bgColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-success text-white';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-danger text-white';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-warning text-white';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-primary text-white';
                    icon = 'fa-info-circle';
            }

            notification.className = `flex items-center p-4 rounded-lg shadow-lg ${bgColor} transform transition-all duration-300 translate-y-4 opacity-0`;
            notification.innerHTML = `
                <i class="fa ${icon} mr-3 text-xl"></i>
                <div class="flex-grow">${message}</div>
                <button class="ml-4 text-white/80 hover:text-white">
                    <i class="fa fa-times"></i>
                </button>
            `;

            container.appendChild(notification);

            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            // 自动关闭
            const timeout = setTimeout(() => {
                closeNotification(notification);
            }, 5000);

            // 点击关闭
            notification.querySelector('button').addEventListener('click', () => {
                clearTimeout(timeout);
                closeNotification(notification);
            });
        }

        function closeNotification(notification) {
            notification.classList.add('translate-y-4', 'opacity-0');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }

        // ==============================================
        // 服务器分配逻辑
        // ==============================================
        function findSuitableServer(requiredCores) {
            const candidates = servers.filter(server => server.totalCores - server.usedCores >= requiredCores);

            if (candidates.length === 0) {
                return null;
            }

            // 优先选择剩余核数最少的服务器
            candidates.sort((a, b) => (a.totalCores - a.usedCores) - (b.totalCores - b.usedCores));
            return candidates[0];
        }

        // ==============================================
        // 表单提交处理
        // ==============================================
        function handleFormSubmit(e) {
            e.preventDefault();

            clearFormErrors();

            const applicant = document.getElementById('applicant').value.trim();
            const cores = parseInt(document.getElementById('cores').value);
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const purpose = document.getElementById('purpose').value.trim();

            let isValid = true;

            // 验证输入
            if (!applicant) {
                showFormError('applicant', '请输入申请人姓名');
                isValid = false;
            }
            
            if (isNaN(cores) || cores < 1 || cores > 192) {
                showFormError('cores', '请输入有效的核数（1-192之间）');
                isValid = false;
            }

            if (!startTime) {
                showFormError('start-time', '请选择开始时间');
                isValid = false;
            }

            if (!endTime) {
                showFormError('end-time', '请选择结束时间');
                isValid = false;
            } else if (new Date(startTime) >= new Date(endTime)) {
                showFormError('end-time', '结束时间必须晚于开始时间');
                isValid = false;
            }

            if (!isValid) {
                showNotification('表单填写有误，请检查并修正', 'error');
                return;
            }

            // 查找合适的服务器
            const server = findSuitableServer(cores);
            if (!server) {
                showNotification('抱歉，没有足够资源的服务器可用', 'error');
                return;
            }

            try {
                // 创建新记录
                const newRecord = {
                    applicant,
                    cores,
                    startTime,
                    endTime,
                    purpose,
                    serverId: server.id
                };

                // 更新服务器数据
                server.usedCores += cores;
                server.tasks.push(Date.now().toString()); // 使用时间戳作为临时ID
                
                // 保存服务器数据更新
                const ServerClass = AV.Object.extend('Server');
                const serverObject = new ServerClass();
                serverObject.set('objectId', server.objectId); // 使用LeanCloud的objectId
                serverObject.set('id', server.id);
                serverObject.set('totalCores', server.totalCores);
                serverObject.set('usedCores', server.usedCores);
                serverObject.set('tasks', server.tasks);
                serverObject.save();

                // 保存新记录
                const RecordClass = AV.Object.extend('Record');
                const recordObject = new RecordClass();
                recordObject.set('applicant', newRecord.applicant);
                recordObject.set('cores', newRecord.cores);
                recordObject.set('startTime', newRecord.startTime);
                recordObject.set('endTime', newRecord.endTime);
                recordObject.set('purpose', newRecord.purpose);
                recordObject.set('serverId', newRecord.serverId);
                recordObject.save();

                // 显示成功通知
                showNotification(`申请成功！已分配到服务器 #${server.id}`, 'success');

                // 重置表单
                document.getElementById('resource-form').reset();
                initDateTimePickers();
            } catch (error) {
                console.error('申请处理出错:', error);
                showNotification('处理申请时发生错误，请重试', 'error');
            }
        }

        // ==============================================
        // 搜索记录
        // ==============================================
        function searchRecords(query) {
            if (!query.trim()) {
                updateRecordsTable();
                return;
            }

            const filteredRecords = records.filter(record => 
                record.applicant.toLowerCase().includes(query.toLowerCase()) ||
                (record.purpose && record.purpose.toLowerCase().includes(query.toLowerCase())) ||
                `服务器 #${record.serverId}`.includes(query) ||
                record.cores.toString().includes(query)
            );

            const tableBody = document.getElementById('records-table');
            tableBody.innerHTML = '';

            if (filteredRecords.length === 0) {
                tableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="6" class="px-4 py-8 text-gray-500">没有找到匹配的记录</td>
                    </tr>
                `;
                return;
            }

            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';

                const now = new Date();
                const startTime = new Date(record.startTime);
                const endTime = new Date(record.endTime);

                let statusClass = '';
                let statusText = '';

                if (now < startTime) {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = '等待中';
                } else if (now >= startTime && now <= endTime) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = '使用中';
                } else {
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusText = '已结束';
                }

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">${record.applicant}</td>
                    <td class="px-4 py-4 whitespace-nowrap">服务器 #${record.serverId}</td>
                    <td class="px-4 py-4 whitespace-nowrap">${record.cores}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${formatDateTime(startTime)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">${formatDateTime(endTime)}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // ==============================================
        // 页面加载完成后初始化
        // ==============================================
        document.addEventListener('DOMContentLoaded', init);
        
        // ==============================================
        // 页面关闭时清理订阅
        // ==============================================
        window.addEventListener('beforeunload', () => {
            if (serverSubscription) serverSubscription.unsubscribe();
            if (recordSubscription) recordSubscription.unsubscribe();
        });
    </script>
</body>
</html>
